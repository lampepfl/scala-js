#!/bin/sh

BASEDIR="`dirname $0`/.."

FULLVER="$1"

case $FULLVER in
  2.11.12)
    VER=2.11
    ;;
  2.12.12)
    VER=2.12
    ;;
  2.13.3)
    VER=2.13
    ;;
  2.12.1|2.12.2|2.12.3|2.12.4|2.12.5|2.12.6|2.12.7|2.12.8|2.12.9|2.12.10|2.12.11|2.13.0|2.13.1|2.13.2)
    echo "Ignoring checksizes for Scala $FULLVER"
    exit 0
    ;;
esac

REVERSI_PREOPT="$BASEDIR/examples/reversi/.$VER/target/scala-$VER/reversi-dev/main.js"
REVERSI_OPT="$BASEDIR/examples/reversi/.$VER/target/scala-$VER/reversi-prod/main.js"

REVERSI_PREOPT_SIZE=$(stat '-c%s' "$REVERSI_PREOPT")
REVERSI_OPT_SIZE=$(stat '-c%s' "$REVERSI_OPT")

gzip -c "$REVERSI_PREOPT" > "$REVERSI_PREOPT.gz"
gzip -c "$REVERSI_OPT" > "$REVERSI_OPT.gz"

REVERSI_PREOPT_GZ_SIZE=$(stat '-c%s' "$REVERSI_PREOPT.gz")
REVERSI_OPT_GZ_SIZE=$(stat '-c%s' "$REVERSI_OPT.gz")

case $FULLVER in
  2.11.12)
    REVERSI_PREOPT_EXPECTEDSIZE=435000
    REVERSI_OPT_EXPECTEDSIZE=94000
    REVERSI_PREOPT_GZ_EXPECTEDSIZE=59000
    REVERSI_OPT_GZ_EXPECTEDSIZE=27000
    ;;
  2.12.12)
    REVERSI_PREOPT_EXPECTEDSIZE=667000
    REVERSI_OPT_EXPECTEDSIZE=126000
    REVERSI_PREOPT_GZ_EXPECTEDSIZE=81000
    REVERSI_OPT_GZ_EXPECTEDSIZE=33000
    ;;
  2.13.3)
    REVERSI_PREOPT_EXPECTEDSIZE=686000
    REVERSI_OPT_EXPECTEDSIZE=146000
    REVERSI_PREOPT_GZ_EXPECTEDSIZE=90000
    REVERSI_OPT_GZ_EXPECTEDSIZE=40000
    ;;
esac

echo "Checksizes: Scala version: $FULLVER"
echo "Reversi preopt size = $REVERSI_PREOPT_SIZE (expected $REVERSI_PREOPT_EXPECTEDSIZE)"
echo "Reversi opt size = $REVERSI_OPT_SIZE (expected $REVERSI_OPT_EXPECTEDSIZE)"
echo "Reversi preopt gzip size = $REVERSI_PREOPT_GZ_SIZE (expected $REVERSI_PREOPT_GZ_EXPECTEDSIZE)"
echo "Reversi opt gzip size = $REVERSI_OPT_GZ_SIZE (expected $REVERSI_OPT_GZ_EXPECTEDSIZE)"

[ "$REVERSI_PREOPT_SIZE" -le "$REVERSI_PREOPT_EXPECTEDSIZE" ] && \
  [ "$REVERSI_OPT_SIZE" -le "$REVERSI_OPT_EXPECTEDSIZE" ] && \
  [ "$REVERSI_PREOPT_GZ_SIZE" -le "$REVERSI_PREOPT_GZ_EXPECTEDSIZE" ] && \
  [ "$REVERSI_OPT_GZ_SIZE" -le "$REVERSI_OPT_GZ_EXPECTEDSIZE" ]
